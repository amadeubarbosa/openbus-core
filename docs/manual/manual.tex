\documentclass[a4paper,11pt]{article}

%% Estilos e Plug-Ins
\usepackage{a4wide}
\usepackage{times}
\usepackage[latin1]{inputenc}
\usepackage[brazil]{babel}

% ===================
% Início do documento
% ===================
\begin{document}

\newcommand{\OPHOME}{{\tt OPENBUS\_HOME}}

\title{OpenBus\\Manual do Usuário Desenvolvedor}
\author{}
\date{}
\maketitle

\begin{abstract}
Este documento visa auxilar novos usuários na instalação do sistema.
Assume-se que o usuário tenha lido o documento sobre a arquitetura do OpenBus.
\end{abstract}

\section{Checkout do Subversion}
Os fontes do OpenBus são armazenados num sistema de controle 
de versão -- o subversion (http://subversion.tigris.org/).
A URL para o OpenBus é {\tt
https://subversion.tecgraf.puc-rio.br/engsoftware/openbus/trunk/}
Para obter os fontes é necessário que o usuário tenha uma conta no tecgraf.
A senha Unix deve ser usada para autenticação.

Para criar um diretório {\tt openbus}  com os fontes do Openbus, basta
executar o comando:
\begin{verbatim}
svn co https://subversion.tecgraf.puc-rio.br/engsoftware/openbus/trunk openbus
\end{verbatim}

\section{Organização de diretórios}

\begin{itemize}
\item bin \\
Contém os scripts de execução dos serviços básicos para ambos os modos
de execução (binários estáticos ou através do interpretador Lua).

\item conf \\
Contém arquivos Lua, que configuram os serviços básicos, o script
config, que configura as variáveis de ambiente e, no diretório advanced, os 
arquivos Lua que configuram os interceptadores.

\item demo \\
Contém um exemplo em Lua de um serviço OpenBus (publisher.lua) e de um 
cliente OpenBus (consumer.lua).

\item docs \\
Contém os documentos relacionados ao OpenBus (proposta, apresentações,
manuais, etc).

\item include \\
Headers do OiL e do Mico. 
?? Servem para compilar as bibliotecas C++ para acesso ao OpenBus e criação
de serviços.

\item lib \\
Contém as bibliotecas utilizadas pelo OpenBus.
== Falar de cada uma delas!

\subitem Java (commons-codec, Jacorb e SCS), 
\subitem Lua (lce, posix, ldap e uuid).

\item src \\
Contém a implementação dos serviços básicos e de bibliotecas auxiliares
para implementação de clientes e servidores para o OpenBus.
Implementações C++, Java e Lua.

\subitem c \\
Fontes e makefiles (formato tecmake) para os binários estáticos.

\subitem idl \\
Idls dos serviços básicos e de serviços de dados.
?? A idl do serviço de projetos deveria estar aqui?!

\subitem cpp \\ 
Bibliotacas C++ para acesso ao OpenBus e criação de serviços.

\subitem java \\
Classes auxiliares para acesso ao OpenBus.

\subitem lua \\
Implementação dos serviços básicos e de classes auxiliares para acesso
ao OpenBus.

\item test \\
Contém os testes dos serviços básicos e de clientes e servidores.

\subitem bin \\
Contém scripts para a execução dos testes.
?? cpp



\end{itemize}
Makefile
build.xml

\section{Ambiente de Desenvolvimento}

É necessário instalar as seguintes bibliotecas:

\begin{tabular}{lcll}
Biblioteca & Versão & tag     & Serviços \\ \hline
doxygen    & x      & docs    &          \\ \hline
lua        & 5.1    &         &          \\ \hline 
luasocket  & 2.0.1  &         &          \\ \hline 
oil        & 0.4    &         &          \\ \hline 
openldap   & 2.1    & libs    & acesso   \\ \hline
openssl    & 0.9.9  & libs    & acesso   \\ \hline
posix      & x      & libs    & básicos  \\ \hline
tolua      & 5.1b   & usrlibs &          \\ \hline
uuid       & x      & libs    & básicos  \\ \hline
scs        & x      &         & básicos  \\ \hline
latt       & 1.0.0  &         & básicos  \\ \hline
\end{tabular}

\section{Configuração do ambiente fora do TecGraf}

Em particular, são necessários passos extras para a montagem do ambiente em
notebooks ou em máquinas pessoais que não usem os compartilhamentos de rede do
TecGraf. Nesta seção assumimos que o desenvolvedor tenha preferência por usar
as bibliotecas já disponíveis para seu sistema operacional. Adicionalmente,
para evitar possíveis problemas com o estado atual da sua instalação,
recomendamos o uso do utilitário {\tt schroot} conforme exemplo em: {\tt
http://www.debian-administration.org/articles/566}.

\subsection{Instalação e configuração do Tecmake}

O OpenBUS utiliza o utilitário Tecmake ({\tt
http://www.tecgraf.puc-rio.br/tecmake}) para seu processo de compilação. O
Tecmake utiliza um conjunto de variáveis de ambiente para reconhecer sua
plataforma, deduzir as flags de compilação e linquedição mais adequadas, bem
como os caminhos para bibliotecas e arquivos de cabeçalho do sistema. Algumas
variáveis importantes são:
\begin{itemize}
\item {\tt TECMAKE\_HOME} : sua própria localização (ex: ~/tecmake)
\item {\tt TECTOOLS\_HOME} : diretório com outras bibliotecas (ex: ~/tools)
\item {\tt TEC\_UNAME} : definida automaticamente conforme sua plataforma (ex:
Linux26g4, que representa kernel Linux série 2.6 e compilador GCC versão 4)
\end{itemize}

Para instalar o Tecmake siga:
\begin{enumerate}
\item Baixe a última versão do Tecmake a partir da URL acima 
\item Certifique-se que tenha instalado os pacotes {\tt make gcc g++ libc-dev
file csh libreadline-dev}
\item Extraia o pacote do Tecmake uma pasta, ex: {\tt ~/tecmake} e
forneça permissão de execução aos scripts:
\begin{verbatim}
cd tecmake; chmod +x *.bsh *.csh tecmake *cc remote cx*;
\end{verbatim}
\item Inclua na sua variável de ambiente {\tt PATH} o caminho no qual extraiu o
Tecmake
\item Edite o arquivo {\tt tec\_uname.bsh} (se o shell for o bash) ou
{\tt tec\_uname.csh} (se o shell for o csh) para atualizar a definição das
variáveis: {\tt TECTOOLS\_HOME} e {\tt TECMAKE\_HOME}
\item Inclua a chamada para o {\tt tec\_uname.bsh} ou {\tt tec\_uname.csh} no
seu {\tt .bashrc} ou {\tt .cshrc}, respectivamente
\end{enumerate}

\subsection{Instalação das dependências do OpenBus}

Neste passo é preciso já ter instalado no sistema os pacotes: lua5.1
liblua5.1-dev. Caso não tenha pacotes próprios de sua distribuição então
pode-se instalar de forma similar às outras bibliotecas listadas abaixo,
assumindo o diretório /usr/local como local de instalação para o Lua.

Por padrão, o Tecmake apenas busca automaticamente pelas seguintes bibliotecas
dentro do {\tt TECTOOLS\_HOME}: cd im iup lua lua4 lua5. Contudo o OpenBUS
depende de outras bibliotecas Lua externas como {\tt luasocket2}, {\tt oil} e
{\tt tolua}. É preciso instalá-las e configurar outras variáveis de ambiente.

\subsubsection{OiL (>= 0.4-work8)}
\begin{enumerate}
\item Baixar o OiL de {\tt http://luaforge.net/projects/oil/}, extrair em
alguma pasta e alterar no arquivo {\tt config} do OiL as variáveis a seguir
\item {\tt LUA\_HOME}: raiz onde o Lua está instalado, tipicamente /usr ou
/usr/local
\item {\tt LUA\_INC}: caminho para os cabeçalhos da API C de Lua,
tipicamente {\tt \$(LUA\_HOME)/include/lua5.1}
\item {\tt LUA\_LIB}: caminho para as bibliotecas compiladas de Lua,
tipicamente {\tt \$(LUA\_HOME)/lib}
\item {\tt INSTALL\_TOP}: onde instalar o OiL, tipicamente /usr/local
\item {\tt INSTALL\_INC}: onde instalar os cabeçalhos C do OiL, tipicamente
{\tt \$(INSTALL\_TOP)/include/lua5.1}
\item {\tt INSTALL\_LIB}: onde instalar as bibliotecas do OiL a serem
compiladas, tipicamente {\tt \$(INSTALL\_TOP)/lib}
\item Caso sua instalação do Lua disponibilize a biblioteca liblua5.1.so ao
invés de liblua.so, então altere na variável {\tt LIBS} o parâmetro de "-llua"
para "-llua5.1".
\item Compilar e instalar o OiL com {\tt make \&\& make install \&\& make
installp} (o último é preciso para a liboilall.so)
\end{enumerate}

\subsubsection{Luasocket2 (>= 2.0.2)}
\begin{enumerate}
\item Caso haja um pacote liblua5.1-socket-dev disponível em sua instalação,
pule para a subseção seguinte
\item Baixar o Luasocket2 de {\tt http://luaforge.net/projects/luasocket2},
extrair em alguma pasta e alterar no arquivo {\tt config} as variáveis a seguir
\item {\tt LUAINC}: flag usada para informar o caminho dos cabeçalhos da API C
de Lua, tipicamente -I/usr/include/lua5.1
\item {\tt INSTALL\_TOP\_SHARE}: onde instalar os arquivos .lua, tipicamente
/usr/local/share/lua/5.1
\item {\tt INSTALL\_TOP\_LIB}: onde instalar as bibliotecas do Luasocket2 a
serem compiladas, tipicamente /usr/local/lib/lua/5.1
\item Compilar e instalar o Luasocket2 com {\tt make \&\& make install}
\item Em particular, a instalação não instala os arquivos de cabeçalho {\tt
luasocket.h mime.h unix.h} que podem ser copiados manualmente para o
/usr/include/lua5.1 ou /usr/local/include/lua5.1
\end{enumerate}

\subsubsection{ToLua (>= 5.0)}
\begin{enumerate}
\item Baixar o ToLua de {\tt
ftp://ftp.tecgraf.puc-rio.br/pub/users/celes/tolua/tolua-5.1b.tar.gz}, extrair
em alguma pasta e alterar no arquivo {\tt config} as variáveis a seguir
\item {\tt LUA}: raiz onde o Lua está instalado, tipicamente /usr ou /usr/local
\item {\tt LUAINC}:  caminho para os cabeçalhos da API C de Lua, tipicamente
{\tt \$(LUA)/include/lua5.1}
\item {\tt LUALIB}: caminho para as bibliotecas compiladas de Lua, tipicamente
{\tt \$(LUA)/lib}
\item Inclua a definição da variável {\tt TOLUA} apontando para a pasta onde
você extraiu o ToLua
\item Adicione ao final da definição da variável {\tt WARN} o parâmetro -fPIC
\item Por padrão, os arquivos Makefile do ToLua compilam as suas bibliotecas
usando "-llua" como parâmetro ao compilador C. Contudo, em algumas instalações
o correto seria "-llua5.1". Para alterar isso entre na pasta onde você extraiu
o ToLua e execute:
\begin{verbatim}
find . -iname makefile -exec sed -i -e 's/llua/llua5.1/g' {} +
\end{verbatim}
\item O Makefile principal (na raiz do ToLua) não possui regras para
instalação, então é conveniente adicionar ao final deste:
\begin{verbatim}
INSTALL_TOP=/usr/local
install:
	install -m 644 lib/libtolua.a $(INSTALL_TOP)/lib/
	mkdir -p $(INSTALL_TOP)/include/lua5.1
	install -m 644 include/tolua.h $(INSTALL_TOP)/include/lua5.1/
	install -m 755 bin/tolua $(INSTALL_TOP)/bin/
\end{verbatim}
\item Compilar e instalar o ToLua com {\tt make \&\& make install}
\end{enumerate}

\subsubsection{Exportando variáveis de ambiente para o Tecmake}
\label{vartecmake}

Uma vez instaladas estas bibliotecas principais será preciso criar variáveis de
ambiente adequadas ao funcionamento do Tecmake. Este as usará como caminhos
relativos para os momentos de compilação e linquedição. Os caminhos são
relativos ao valor da variável {\tt TECTOOLS\_HOME}, por isso precisamos:
\begin{enumerate}
\item Criar diretórios compatíveis com a hierarquia necessária para o Tecmake:
\begin{verbatim}
cd ${TECTOOLS_HOME};
for cada in $(echo lua51 oil04 luasocket2 tolua)
do 
  mkdir -p $cada/lib;
  mkdir -p $cada/bin;
done
\end{verbatim}
\item Faça os links simbólicos adequados aos seus locais de instalação tanto do
Lua5.1 quanto das bibliotecas (aqui assumimos que apenas o Lua5.1 e o
Luasocket2 estão instalados por pacotes no /usr, as outras estão em
/usr/local):
\begin{verbatim}
cd ${TECTOOLS_HOME};
# Lua5.1
ln -sf /usr/include/lua5.1 lua51/include;
ln -sf /usr/bin lua51/bin/${TEC_UNAME};
ln -sf /usr/lib lua51/lib/${TEC_UNAME};
# Luasocket2
ln -sf /usr/include/lua5.1 luasocket2/include;
ln -sf /usr/bin luasocket2/bin/${TEC_UNAME};
ln -sf /usr/lib luasocket2/lib/${TEC_UNAME};
# OiL0.4
ln -sf /usr/local/include/lua5.1 oil04/include;
ln -sf /usr/local/bin oil04/bin/${TEC_UNAME};
ln -sf /usr/local/lib oil04/lib/${TEC_UNAME};
# Tolua
ln -sf /usr/local/include/lua5.1 tolua/include;
ln -sf /usr/local/bin tolua/bin/${TEC_UNAME};
ln -sf /usr/local/lib tolua/lib/${TEC_UNAME};
\end{verbatim}
\item Então é preciso criar as variável no padrão NOME, NOMEINC, NOMELIB e
colocá-las em seu {\tt tec\_uname.bsh} ou {\tt tec\_uname.csh}. Aqui mostramos
um "for" para automatizar o processo segundo a sintaxe do bash (em csh é bem
parecido):
\begin{verbatim}
INCNAME=INC
LIBNAME=LIB
for produto in `ls ${TECTOOLS_HOME}`; do
   PROD=`echo $produto|tr \[a-z\] \[A-Z\]|tr -d \.`
   export $PROD=$TECTOOLS_HOME/$produto
   export $PROD$INCNAME=$TECTOOLS_HOME/$produto/include
   export $PROD$LIBNAME=$TECTOOLS_HOME/$produto/lib/$TEC_UNAME
   PROD=
done
\end{verbatim}
\end{enumerate}

\subsubsection{Exportando as variáveis de ambiente para o Lua}

Uma vez instaladas as bibliotecas e configuradas às variáveis úteis ao Tecmake,
só nos falta ajustar os caminhos para as variáveis {\tt LUA\_PATH} e {\tt
LUA\_CPATH} para que a máquina virtual do Lua possa encontrar as bibliotecas.
Sugerimos incluir estas definições em seu {\tt tec\_uname.bsh} ou {\tt
tec\_uname.csh} (no caso deste último use setenv ao invés de export):
\begin{verbatim}
export LUA_VERSION="5.1"
export LIBPATH="/usr/local/lib"
export LIBPATH_LUA="/usr/local/share/lua/$LUA_VERSION"
export LIBPATH_ARCH="/usr/local/lib/lua/$LUA_VERSION"

export LUA_PATH="/usr/share/lua/$LUA_VERSION/?.lua;/usr/share/lua/$LUA_VERSION/?/init.lua"
export LUA_CPATH="/usr/lib/lua/$LUA_VERSION/?.so"

export LUA_PATH="./?.lua;./?/init.lua;$LIBPATH_LUA/?.lua;$LIBPATH_LUA/?/init.lua;$LUA_PATH"
export LUA_CPATH="./?.so;./lib?.so;$LIBPATH_ARCH/?.so;$LIBPATH_ARCH/lib?.so;$LIBPATH_ARCH/lua/$LUA_VERSION/?.so;$LUA_CPATH"
\end{verbatim}

\section{Compilação}

A variável de ambiente {\tt OPENBUS\_HOME} deve ser definida pelo
usuário. Ela deve apontar para o diretório para o qual o usuário fez
checkout do subversion.

Configurar a localização da biblioteca OpenSSL em
{\tt lib/lua/lce-1.0.0/src/config.mak}

Configurar a localização da biblioteca toLua em
{\tt src/cpp/oil/config}


O Makefile do OpenBus possui as seguintes tags para compilação:
{\tt doc}, {\tt idl}, {\tt libs}, {\tt bins} e {\tt usrlibs}.
A tag {\tt doc} gera a documentação no format doxygen.
{\tt idl}  cria um link no diretório {\tt OPENBUS\_HOME} para o diretório que
contém as idls.
{\tt libs} compila as bibliotecas Lua usadas pelos serviços
básicos. Essas bibliotecas serão geradas no diretório {\tt
OPENBUS\_HOME}/libpath.
{\tt bins} gera os binários estáticos dos serviços básicos.
{\tt usrlibs} gera as bibliotecas C++ para acesso ao OpenBus.

\section{Execução dos Serviços Básicos}

Deve ser possível executar os serviços básicos nas seguintes
plataformas:
Windows XP
Linux26g4
Solaris510

 
===== Como fazemos para gerar as chaves dos serviços básicos?!?!?!

A variável de ambiente {\tt OPENBUS\_HOME} deve ser definida pelo
usuário. Ela deve apontar para o diretório para o qual o usuário fez
checkout do subversion.

Os serviços básicos devem ser configurados através de arquivos Lua.

\begin{itemize}
\item conf/AccessControlServerConfiguration.lua \\
Máquina e porta do serviço de acesso.
\begin{verbatim}
  hostName = "localhost",
  hostPort = 2089,
\end{verbatim}
Máquina e porta do serviço LDap.
\begin{verbatim}
  ldapHostName = "segall.tecgraf.puc-rio.br",
  ldapHostPort = 389,
\end{verbatim}
Diretório onde ficam os certificados gerados por ???
\begin{verbatim}
  certificatesDirectory = "../certificates",
\end{verbatim}
Chave privada do serviço de acesso.
\begin{verbatim}
  privateKeyFile = "../certificates/AccessControlService.key",
\end{verbatim}
Diretório onde serão armazenadas as credenciais.
\begin{verbatim}
  databaseDirectory = "../credentials",
\end{verbatim}
Nível de log do serviço de acesso. Quanto maior o nível, maior o número
de mensagens.
\begin{verbatim}
  logLevel = 3,
\end{verbatim}
Nível de log do OiL. Quanto maior o nível, maior o número de mensagens.
\begin{verbatim}
  oilVerboseLevel = 1,
\end{verbatim}

\item conf/RegistryServerConfiguration.lua \\
Máquina e porta do serviço de acesso. 
\begin{verbatim}
  accessControlServerHostName = "localhost",
  accessControlServerHostPort = 2089,
\end{verbatim}
Chave privada do serviço de registro.
\begin{verbatim}
  privateKeyFile = "../certificates/RegistryService.key",
\end{verbatim}
  Chave pública do controle de acesso.
\begin{verbatim}
  accessControlServiceCertificateFile = "../certificates/AccessControlService.crt",
\end{verbatim}
Diretório onde serão armazenadas as ofertas de serviço.
\begin{verbatim}
  databaseDirectory = "../offers",
\end{verbatim}
Nível de log do serviço de acesso. Quanto maior o nível, maior o número
de mensagens.
\begin{verbatim}
  logLevel = 3,
\end{verbatim}
Nível de log do OiL. Quanto maior o nível, maior o número de mensagens.
\begin{verbatim}
  oilVerboseLevel = 1,
\end{verbatim}

\item conf/SessionServerConfiguration.lua \\

Máquina e porta do serviço de acesso.
\begin{verbatim}
  accessControlServerHostName = "localhost",
  accessControlServerHostPort = 2089,
\end{verbatim}
Chave privada do serviço de registro.
\begin{verbatim}
  privateKeyFile = "../certificates/SessionService.key",
\end{verbatim}
  Chave pública do controle de acesso.
\begin{verbatim}
  accessControlServiceCertificateFile = "../certificates/AccessControlService.cr
\end{verbatim}
Tipo do serviço oferecido pelo serviço de Sessão.
\begin{verbatim}
  sessionServiceOfferType = "SessionService",
\end{verbatim}
Nível de log do serviço de acesso. Quanto maior o nível, maior o número
de mensagens.
\begin{verbatim}
  logLevel = 3,
\end{verbatim}
Nível de log do OiL. Quanto maior o nível, maior o número de mensagens.
\begin{verbatim}
  oilVerboseLevel = 1,
\end{verbatim}

\end{itemize}

\subsection{Através do interpretador Lua}

Usar os scripts {\tt bin/run\_access\_control\_server.sh} para o serviço
de acesso, {\tt bin/run\_registry\_server.sh} para o serviço de registro e 
{\tt bin/run\_session\_server.sh} para o serviço de sessão.
 
\subsection{Através de binários}
 
Colocar no {\tt LD\_LIBRARY\_PATH} {\tt \OPHOME/libpath/\$TEC\_UNAME}.

Usar os scripts {\tt bin/accesscontrol\_service} para o serviço
de acesso, {\tt bin/registry\_service} para o serviço de registro e 
{\tt bin/session\_service} para o serviço de sessão.
 

\section{Pacote de instalação}

Pacote para usuários **não** desenvolvedores de serviços básicos.

O que deve entrar no pacote de instalação?
O que NÃO deve entrar?

\section{Padrões}
Abreviação
- nomes de diretórios
- nomes de arquivos

\section{FAQ}

\subsection{Configurar libreadline.so.5}

\subsection{Permissões dos arquivos so}

\subsection{Variável está setada e exportada?}

\subsection{``:'' no path}

\subsection{Localização de libs dinâmicas}

\subsection{{\tt LUA\_PATH} e {\tt LUA\_CPATH}}

\subsection{Can't contact LDAP server}

\subsection{Usuário não existe no servidor LDAP}

\subsection{unable to bind to port of host}

\subsection{Como acessar o usuário que chamou o serviço para fazer a
autorização?}



\end{document}


