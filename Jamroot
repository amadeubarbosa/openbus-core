# -*- coding: iso-8859-1-unix -*-

import os ;
import modules ;

path-constant here : . ;

local lua-jam-path = [ os.environ LUA_JAM_PATH ] ;
if ! $(lua-jam-path)
{
  lua-jam-path = "$(here)/../lua.jam" ;
}
use-project lua : $(lua-jam-path) ; 

local lce-root-path = [ os.environ LCE_ROOT_PATH ] ;
if ! $(lce-root-path)
{
  lce-root-path = "$(here)/../lce" ;
}
use-project lce : $(lce-root-path) ;

local lualdap-root-path = [ os.environ LUALDAP_ROOT_PATH ] ;
if ! $(lualdap-root-path)
{
  lualdap-root-path = "$(here)/../lualdap" ;
}
use-project lualdap : $(lualdap-root-path) ;

local luuid-root-path = [ os.environ LUUID_ROOT_PATH ] ;
if ! $(luuid-root-path)
{
  luuid-root-path = "$(here)/../luuid" ;
}
use-project luuid : $(luuid-root-path) ;

local openssl-jam-path = [ os.environ OPENSSL_JAM_PATH ] ;
if ! $(openssl-jam-path)
{
  openssl-jam-path = "$(here)/../openssl.jam" ;
}
use-project openssl : $(openssl-jam-path) ; 

local lfs-root-path = [ os.environ LFS_ROOT_PATH ] ;
if ! $(lfs-root-path)
{
  lfs-root-path = "$(here)/../luafilesystem" ;
}
use-project lfs : $(lfs-root-path) ;

local luavararg-root-path = [ os.environ LUAVARARG_ROOT_PATH ] ;
if ! $(luavararg-root-path)
{
  luavararg-root-path = "$(here)/../luavararg" ;
}
use-project luavararg : $(luavararg-root-path) ;

local luastruct-root-path = [ os.environ LUASTRUCT_ROOT_PATH ] ;
if ! $(luastruct-root-path)
{
  luastruct-root-path = "$(here)/../luastruct" ;
}
use-project luastruct : $(luastruct-root-path) ;

local luasocket-root-path = [ os.environ LUASOCKET_ROOT_PATH ] ;
if ! $(luasocket-root-path)
{
  luasocket-root-path = "$(here)/../luasocket" ;
}
use-project luasocket : $(luasocket-root-path) ;

loop-root-path = [ os.environ LOOP_ROOT_PATH ] ;
if ! $(loop-root-path)
{
  loop-root-path = "$(here)/../loop" ;
}
use-project loop : $(loop-root-path) ;

oil-root-path = [ os.environ OIL_ROOT_PATH ] ;
if ! $(oil-root-path)
{
  oil-root-path = "$(here)/../oil" ;
}
use-project oil : $(oil-root-path) ;

local luascs-root-path = [ os.environ LUASCS_ROOT_PATH ] ;
if ! $(luascs-root-path)
{
  luascs-root-path = "$(here)/../scs-lua" ;
}
use-project luascs : $(luascs-root-path) ;

local luaopenbus-root-path = [ os.environ LUAOPENBUS_ROOT_PATH ] ;
if ! $(luaopenbus-root-path)
{
  luaopenbus-root-path = "$(here)/../openbus-lua" ;
}
use-project luaopenbus : $(luaopenbus-root-path) ;

local luasec-root-path = [ os.environ LUASEC_ROOT_PATH ] ;
if ! $(luasec-root-path)
{
  luasec-root-path = "$(here)/../luasec" ;
}
use-project luasec : $(luasec-root-path) ;

local lualdap-root-path = [ os.environ LUALDAP_ROOT_PATH ] ;
if ! $(lualdap-root-path)
{
  lualdap-root-path = "$(here)/../lualdap" ;
}
use-project lualdap : $(lualdap-root-path) ;

local openldap-jam-path = [ os.environ OPENLDAP_JAM_PATH ] ;
if ! $(openldap-jam-path)
{
  openldap-jam-path = "$(here)/../openldap.jam" ;
}
use-project openldap : $(openldap-jam-path) ; 

scs-idl-path = [ os.environ SCS_IDL_PATH ] ;
if ! $(scs-idl-path)
{
  scs-idl-path = "$(here)/../scs-idl" ;
}

openbus-idl-path = [ os.environ OPENBUS_IDL_PATH ] ;
if ! $(openbus-idl-path)
{
  openbus-idl-path = "$(here)/../openbus-idl" ;
}

openbus-legacy-idl-path = [ os.environ OPENBUS_LEGACY_IDL_PATH ] ;
if ! $(openbus-legacy-idl-path)
{
  openbus-legacy-idl-path = "$(here)/../openbus-legacy-idl" ;
}

openbus-lib-idl-path = [ os.environ OPENBUS_LIB_IDL_PATH ] ;
if ! $(openbus-lib-idl-path)
{
  openbus-lib-idl-path = "$(here)/../openbus-lib-idl" ;
}

modules.load preloader : : $(loop-root-path) ;
import preloader ; 
using preloader ;

project busservices
  : requirements
    <target-os>windows:<pch>off
    <target-os>windows,<link>shared:<runtime-link>shared
    <target-os>windows,<link>static:<runtime-link>static
    <target-os>windows:<debug-store>database
    <target-os>windows:<define>_CRT_SECURE_NO_WARNINGS
    <target-os>windows:<define>_WIN32
    <define>OPENBUS_PROGNAME=\\\""busservices\\\""
    <toolset>msvc-12.0:<cxxflags>/FS
    <debug-symbols>on
  : default-build
    <variant>release
    <link>static
  ;

make coreservices.c
  : lua/openbus/core/admin/idl.lua
    lua/openbus/core/admin/parsed.lua
    lua/openbus/core/legacy/ServiceWrappers.lua
    lua/openbus/core/services/Access.lua
    lua/openbus/core/services/AccessControl.lua
    lua/openbus/core/services/LoginDB.lua
    lua/openbus/core/services/main.lua
    lua/openbus/core/services/messages.lua
    lua/openbus/core/services/PasswordAttempts.lua
    lua/openbus/core/services/PropertyIndex.lua
    lua/openbus/core/services/OfferRegistry.lua
    lua/openbus/core/services/util.lua
    lua/openbus/core/services/passwordvalidator/LDAP.lua
  : preloader.pre-compile
  : <search>$(here)
  ;

make coreadmin.c
  : lua/openbus/core/admin/Description.lua
    lua/openbus/core/admin/idl.lua
    lua/openbus/core/admin/main.lua
    lua/openbus/core/admin/messages.lua
    lua/openbus/core/admin/parsed.lua
    lua/openbus/core/admin/script.lua
  : preloader.pre-compile
  : <search>$(here)
  ;
  
modules.load idl2lua : : $(oil-root-path) ;
import idl2lua ; 
using idl2lua ;

make lua/openbus/core/admin/parsed.lua 
  : idl/access_management.idl
    idl/offer_authorization.idl
    $(scs-idl-path)/src/scs.idl
    $(openbus-idl-path)/src/openbus_core-2.1.idl
    $(openbus-idl-path)/src/openbus_creden-2.1.idl
    $(openbus-idl-path)/src/openbus_access-2.1.idl
    $(openbus-idl-path)/src/openbus_offers-2.1.idl
  : idl2lua.compile
  : <include>$(openbus-idl-path)/src
    <include>$(openbus-legacy-idl-path)/src
    <include>$(scs-idl-path)/src
  ;

exe busservices
  : coreservices.c
    src/launcher.c
    src/coreservlibs.c
    /lua//lua
    /luuid//luuid
    /lce//lce
    /luafilesystem//lfs
    /luavararg//luavararg
    /luastruct//luastruct
    /luasocket//luasocket
    /loop//loop
    /loop//luatuple
    /loop//luacothread
    /oil//oil
    /oil//luaidl
    /luascs//luascs
    /luaopenbus//luaopenbus
    /luasec//luasec    
  : <dependency>/loop//loop
    <dependency>/loop//luatuple
    <dependency>/loop//luacothread
    <dependency>/oil//oil
    <dependency>/oil//luaidl
    <dependency>/lce//lce
    <dependency>/luascs//luascs
    <dependency>/luaopenbus//luaopenbus
    <target-os>linux:<library>/lualdap//lualdap
    <target-os>linux:<library>/unix//dl
    <target-os>linux:<library>/unix//pthread
    <target-os>darwin:<library>/lualdap//lualdap
    <target-os>linux:<library>/lualdap//lualdap
    <include>src
    <include>.
  ;
explicit busservices ;

exe busadmin
  : src/launcher.c
    src/adminlibs.c
    coreadmin.c
    /lua//lua
    /luuid//luuid
    /lce//lce
    /luafilesystem//lfs
    /luavararg//luavararg
    /luastruct//luastruct
    /luasocket//luasocket
    /loop//loop
    /loop//luatuple
    /loop//luacothread
    /oil//oil
    /oil//luaidl
    /luascs//luascs
    /luaopenbus//luaopenbus
    /luasec//luasec    
  : <dependency>coreadmin.c
    <dependency>/loop//loop
    <dependency>/loop//luatuple
    <dependency>/loop//luacothread
    <dependency>/oil//oil
    <dependency>/oil//luaidl
    <dependency>/lce//lce
    <dependency>/luascs//luascs
    <dependency>/luaopenbus//luaopenbus
    <target-os>linux:<library>/lualdap//lualdap
    <target-os>linux:<library>/unix//dl
    <target-os>linux:<library>/unix//pthread
    <target-os>darwin:<library>/lualdap//lualdap
    <target-os>linux:<library>/lualdap//lualdap
    <include>src
    <include>.    
  ;
explicit busadmin ;
    
install stage
  : busservices
    busadmin
  : <location>install
  ;

install deps
  : busservices
  : <location>install
    <install-dependencies>on
    <install-type>LIB
  ;
explicit deps ;
