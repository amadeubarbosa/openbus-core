%
%  Documento de Instalação do OpenBus 2.1
%
%  Created by Hugo Roenick on 2012-05-22.
%  Copyright (c) 2012 Tecgraf/PUC-Rio. All rights reserved.
%
\documentclass[]{article}

% Use utf-8 encoding for foreign characters
\usepackage[latin1]{inputenc}

\usepackage[brazil]{babel}

% Setup for fullpage use
\usepackage{fullpage}

% Uncomment some of the following if you use the features
%
% Running Headers and footers
%\usepackage{fancyhdr}

% Multipart figures
%\usepackage{subfigure}

% More symbols
%\usepackage{amsmath}
%\usepackage{amssymb}
%\usepackage{latexsym}

\usepackage{hyperref}

% Surround parts of graphics with box
\usepackage{boxedminipage}

% Package for including code in the document
\usepackage{../mwlabinputs2}

% If you want to generate a toc for each chapter (use with book)
\usepackage{minitoc}

% This is now the recommended way for checking for PDFLaTeX:
\usepackage{ifpdf}

\usepackage{html}   %  *always* load this for LaTeX2HTML

%% Redefines the label 'Listing' for ..
\def\lstlistingname{Código}
\codestyle{colorful}

% new commands
\newcommand{\term}[1]{\textit{#1}}
\newcommand{\code}[1]{\texttt{#1}}

\newcommand{\openbus}{\textsc{OpenBus}}
\newcommand{\corba}{\textsc{CORBA}}
\newcommand{\orb}{\textsc{ORB}}
\newcommand{\scs}{\textsc{SCS}}
\newcommand{\lua}{\textsc{Lua}}
\newcommand{\oil}{\textsc{OiL}}
\newcommand{\version}{2.1.0}
\newcommand{\idlversion}{2.1.x}
\newcommand{\legacyidlversion}{2.0.x}


%\newif\ifpdf
%\ifx\pdfoutput\undefined
%\pdffalse % we are not running PDFLaTeX
%\else
%\pdfoutput=1 % we are running PDFLaTeX
%\pdftrue
%\fi

\ifpdf
\usepackage[pdftex]{graphicx}
\else
\usepackage{graphicx}
\fi

\title{Manual de uso do núcleo do \openbus{} \version{}}
\author{Tecgraf}

\date{\today}

\begin{document}

\ifpdf
\DeclareGraphicsExtensions{.pdf, .jpg, .tif}
\else
\DeclareGraphicsExtensions{.eps, .jpg}
\fi

\maketitle

\tableofcontents

\section{Introdução}

Este documento visa informar apenas o procedimento necessário para instalar um barramento \openbus{}~\cite{web:OPENBUS} da versão \version{}.
Caso tenha interesse em entender melhor o que é um barramento \openbus{}, consulte o documento de visão geral~\cite{ob2.1overview}.

\section{Instalação}

O primeiro passo para instalar o barramento deve ser descompactar o pacote do barramento da plataforma desejada.
Os pacotes estão disponibilizados no site oficial do projeto: \url{http://www.tecgraf.puc-rio.br/openbus}.

As plataformas oficialmente suportadas são:
\begin{itemize}
  \item Linux Kernel 2.6 glibc 2.5 64 bits (Linux26g4\_64)
  \item Linux Kernel 2.6 glibc 2.5 32 bits (Linux26g4)
\end{itemize}

Para outras plataformas geramos pacotes sob demanda, exemplos:
\begin{itemize}
  \item Linux Kernel 3.2 glibc 2.11 64 bits (Linux32\_64)
  \item Linux Kernel 3.2 glibc 2.11 32 bits (Linux32)
  \item Linux Kernel 2.4 glibc 2.3 64 bits (Linux24g3\_64)
  \item Linux Kernel 2.4 glibc 2.3 32 bits (Linux24g3)
  \item Solaris 10 release 8/07 SPARC 64 bits (SunOS510\_64)
  \item Solaris 10 release 8/07 SPARC 32 bits (SunOS510)
  \item Windows
\end{itemize}

Os exemplos deste documento utilizam comandos do Bash shell (interpretador de linguagem de comandos)~\cite{web:bash}. 
Para executar o barramento deve-se seguir o seguinte procedimento:

\begin{enumerate}
  \item Extrair o pacote.
  Para fins de legibilidade, vamos guardar o caminho do local da extração em uma variável de ambiente. 
  Porém, \textbf{essa declaração não é obrigatória!}
\begin{verbatim}  
export OPENBUS_HOME=<local de extracao do pacote>
\end{verbatim}
  
  \item Testar se a execução do binário do barramento está funcionando
\begin{verbatim}  
$OPENBUS_HOME/bin/busservices --help
\end{verbatim}

  \item Gerar um par de chaves com tamanho de 2048 bits para o barramento.
  A chave privada (arquivo com terminação \emph{.key}) deve ser do formato PKCS8 codificada em DER, e o certificado (arquivo com terminação \emph{.crt}) deve ser do formato X.509 codificado em DER.
  Esse par de chaves deve ser criado utilizando o comando \emph{openssl} na versão 1.0.0 ou maior.
\begin{verbatim}
  # Para gerar a chave privada, utilize os seguintes comandos:
  openssl genrsa -out tmp_openssl.key 2048

  openssl pkcs8 -topk8 -nocrypt \
    -in tmp_openssl.key -out <nome do par de chaves>.key -outform DER

  rm -f tmp_openssl.key

  # Para gerar o certificado:
  openssl req -days <validade do certificado em dias> -new -x509 \
    -key <nome do par de chaves>.key -keyform DER \
    -out <nome do par de chaves>.crt -outform DER
\end{verbatim}

  \item Configurar os validadores (ver próxima seção) e executar o barramento (binário \emph{busservices}), passando as configurações da chave privada e dos validadores a serem utilizados, as quais são obrigatórias para a execução do OpenBus.

\end{enumerate}

\section{Validadores}

\subsection{Para que servem?}

Os validadores representam o conceito de um módulo Lua~\cite{web:luamodule} responsável por verificar se o par usuário e senha fornecido em uma tentativa de autenticação junto ao barramento é válido. 
Atualmente pode-se utilizar 2 tipos de validadores no OpenBus: validadores de senha e validadores de autenticação externa.

\begin{itemize}
\item Validadores de senha - utilizam funções escritas em Lua para verificar a autenticidade dos usuários.
\item Validadores de autenticação externa - utilizam funções escritas em Lua que utilizam serviços externos para validar uma entidade a partir de um token.
\end{itemize}

\subsection{Validadores de senha}\label{subsec:valsenha}

Um validador de senha precisa ser um módulo Lua~\cite{web:luamodule} que deve retornar uma função que recebe como parâmetro uma tabela de configurações do barramento e retorna uma função \texttt{validator}.
A função \texttt{validator} recebe como primeiro parâmetro o nome de usuário e, como segundo, a senha.
Caso o par usuário/senha seja válido, deve-se retornar verdadeiro, caso contrário, falso.
Um exemplo de validador que verifica se o nome do usuário é igual à senha é dado a seguir:
\begin{verbatim}
-- this is the validator function
local function validator(name, password)
  if name == password then
    return true
  end
end

-- returning the factory to validation function
return function(configs) return validator end
\end{verbatim}

Então, sempre que este módulo for carregado, ele retornará a fábrica de função de validação.
\begin{verbatim}
-- dummy usage example of this validation module
local factory = require "example.of.validator"
local validator = factory() 
local isValid = validator(login, password)
\end{verbatim}

Podemos implementar os validadores tão simples ou seguros como desejarmos.
É importante frisar que o validador personalizado precisa estar no LUA\_PATH para que seja encontrado pelo executável \emph{busservices}.
Um exemplo de como configurar o LUA\_PATH para um validador personalizado é apresentado no FAQ (seção~\ref{sec:faq}).

\subsubsection{Validador LDAP}\label{subsubsec:ldapval}

Junto ao pacote do \openbus{} é fornecido um validador pré-definido para validação via LDAP. Esse validador usa as informações contidas em um serviço de diretórios LDAP para autenticar o acesso de usuários ao barramento. Em ambientes corporativos, é comum a administração da rede utilizar servidores LDAP~\cite{web:rfc4510,wiki:LDAP} para a autenticação de usuários.

Disponibilizado em \texttt{openbus.core.services.passwordvalidator.LDAP}, tem suporte a servidores Microsoft Active Directory e OpenLDAP. As configurações do validador precisam estar no arquivo de configuração que é informado ao \emph{busservices} através do parâmetro \code{-configs}. A seguir apresentamos quais são as propriedades, seus significados e possíveis valores:
\begin{description}
\item[ldap\_servers] indica uma lista de URLs de servidores LDAP. Cada URL deve seguir o formato \\ \texttt{<protocol>://<server>:<port>}, onde \texttt{<protocol>} pode ser \texttt{ldaps} ou \texttt{ldap}. Exemplo:
\begin{verbatim}
ldap_servers = { 
 "ldaps://server.mycompany.com",
 "ldap://otherserver.mycompany.com:389",
}
\end{verbatim}

\item[ldap\_patterns] indica uma lista de padrões de formação de nomes que serão usados na autenticação LDAP. Atualmente só há suporte para o padrão \texttt{\%U}, e o validador irá substituir esse padrão pelo nome do usuário fornecido no ato do login. No exemplo abaixo apresentamos dois padrões, o primeiro é útil para autenticação em servidores Microsoft Active Directory (que utilizam UPN~\cite{web:upn}) e o segundo é útil para autenticação em servidores OpenLDAP (que utilizam DN~\cite{web:dn,web:rfc4514}). Exemplo:
\begin{verbatim}
ldap_patterns = {
  "%U@project.mycompany.com",
  "cn=%U,ou=users,ou=groups,dc=company",
}
\end{verbatim}

\item[ldap\_timeout] indica um tempo máximo de espera (em segundos) da resposta do servidor LDAP. Exemplo:
\begin{verbatim}
ldap_timeout = 10
\end{verbatim}

\item[ldap\_cleartext] indica um valor booleano que determina se a comunicação com o servidor LDAP pode ser feita sem encriptação caso o servidor rejeite conexões LDAP+StartTLS ou a URL não começe com \code{ldaps://}.
Neste caso as senhas podem ser interceptadas por terceiros capazes de observar o tráfego da rede usada para acesso ao servidor LDAP.
Por padrão, essa propriedade não é definida fazendo com que as senhas não sejam trafegadas em claro pela rede.
Exemplo:
\begin{verbatim}
ldap_cleartext = true
\end{verbatim}

\item[ldap\_iorpath] indica um caminho de arquivo que será utilizado para armazenar dados temporários usados internamente pelo \code{busservices}.
Em particular, nesse arquivo é gravado um IOR para acesso a thread de consulta ao serviço LDAP.
Por padrão é utilizado um arquivo temporário indicado pelo sistema.
Exemplo:
\begin{verbatim}
ldap_iorpath = "/tmp/openbus/ldapthread.ior"
\end{verbatim}
\end{description}

\subsection{Validadores de autenticação externa}\label{subsec:valtoken}

Um validador de autenticação externa é implementado de forma similar a um validador de senha, descrito na seção ~\ref{subsec:valsenha}. Contudo, a função \texttt{validator} do validador de autenticação externa recebe os seguintes parâmetros:
\begin{itemize}
  \item Uma string contendo o identificador de login.
  \item Uma string contendo o nome da entidade
  \item Uma string contendo o token a ser validado.
  \item Um objeto a ser usado para construção da cadeia.
  Esse objeto apresenta o método \texttt{push} que recebe como parâmetro um nome de entidade a ser adicionado na cadeia.
  O método devolve como valor de retorno o login ID que essa entidade assume na cadeia sendo criada.
\end{itemize}
O validador deve utilizar algum serviço externo para validar o token recebido e retornar verdadeiro ou falso de acordo com o sucesso ou falha da operação.

\section{O executável \emph{busservices}}\label{sec:busservices}

O barramento e os serviços núcleo são distribuídos em um mesmo programa, o \emph{busservices}. Logo, para disparar o barramento, basta executar o programa passando as suas configurações por linha de comando ou por arquivo de configuração.
Se uma configuração não for explicitada, será utilizado o seu valor padrão.

As opções de configuração são:
\begin{description}
  \item [-iorfile] Arquivo onde o IOR do barramento deve ser escrito.
  \item [-host] Endereço de rede usado pelo barramento.\\
Valor padrão é \code{*}, que significa que vai ouvir em todos os IPs da máquina.
  \item [-port] Número da porta usada pelo barramento.\\
Valor padrão é 2089.

  \item [-sslmode] Ativa o suporte SSL através das opções \code{supported} ou \code{required}.
  \item [-sslport] Número da porta segura a ser usada pelo barramento.
  \item [-sslcapath] Diretório com certificados de CAs a serem usados na autenticação SSL.
  \item [-sslcafile] Arquivo com certificados de CAs a serem usados na autenticação SSL.
  \item [-sslcert] Arquivo com o certificado do barramento.
  \item [-sslkey] Arquivo com a chave privada do barramento.

  \item [-database] Arquivo de dados do barramento.\\
Valor padrão é \code{openbus.db}.
  \item [-privatekey] Arquivo com chave privada do barramento.\\
Valor padrão é \code{openbus.key}.
  \item [-certificate] Arquivo de certificado com chave pública do barramento.\\
Valor padrão é \code{openbus.crt}.

  \item [-timeout] Tempo em segundos de espera por respostas nas chamadas realizadas pelo barramento.\\
Valor padrão é 0 segundos, o que significa que deve esperar indefinidamente.
  \item [-leasetime] Tempo em segundos de lease dos logins de acesso.\\
Valor padrão é 1800 segundos.
  \item [-expirationgap] Tempo em segundos que os logins ficam válidos após o lease.\\
Valor padrão é 10 segundos. 
  \item [-challengetime] Tempo em segundos de duração do desafio de autenticação por certificado.\\
Valor padrão é o valor do parâmetro \code{expirationgap}.
  \item [-sharedauthtime] Tempo em segundos de validade dos segredos de autenticação compartilhada.\\
Valor padrão é o valor do parâmetro \code{leasetime} 

  \item [-badpasswordpenalty] Tempo em segundos com tentativas de login limitadas após falha de senha.\\
Após uma falha de autenticação, este é o período em que o número de falhas de autenticação por senha (ver badpasswordtries) provenientes de um mesmo IP ou entidade será limitado.\\
O valor padrão é 180 segundos.

  \item [-badpasswordtries] Número máximo de tentativas durante o período de badpasswordpenalty.\\
Número máximo de falhas de autenticação por senha de um IP ou entidade.\\
O valor padrão é 3 tentativas.

  \item [-badpasswordlimit] Número máximo de autenticações simultâneas com senha incorreta repassadas para os validadores de senha, ou seja, que ocorram dentro de um tempo curto (menor que 1/badpasswordrate segundos).\\
Por padrão, o controle de fluxo está desativado.

  \item [-badpasswordrate] Frequência máxima de autenticações com senha incorreta repassadas para os validadores de senha em períodos longos (maiores que 2*badpasswordlimit/badpasswordrate segundos).\\
Por padrão, o controle de fluxo está desativado.

  \item [-maxchannels] Número máximo de canais de comunicação com os sistemas.\\
Por padrão, nenhum limite é imposto ao número de canais mantidos abertos com os sistemas clientes.
  \item [-maxcachesize] Tamanho máximo das caches LRU de profiles IOR, sessões de entrada e de saída.\\
O valor padrão é 128 (mesmo valor do campo maxsize da classe loop.collection.LRUCache).

  \item [-admin] Usuário com privilégio de administração.\\
  \item [-validator] Define um validador de senha no formato: \verb|<domain>:<package>| onde \verb|<domain>| é um nome do domínio de autenticação do validador e \verb|<package>| é o nome do pacote Lua que implementa o validador de senhas.\\
A parte \verb|<domain>:| é opcional.
Caso seja omitida, o domínio adotado para o validador é a string vazia.
  \item [-tokenvalidator] Define um validador de autenticação externa no formato: \verb|<domain>:<package>| onde \verb|<domain>| é um nome do domínio de autenticação do validador e \verb|<package>| é o nome do pacote Lua que implementa o validador de autenticação externa.\\
A parte \verb|<domain>:| é opcional.
Caso seja omitida, o domínio adotado para o validador é a string vazia.

  \item [-loglevel] Nível de log gerado pelo barramento.\\
O valor padrão é 3. Os níveis vão de 0 a 5, onde 5 é o nível com mais detalhes, e o 0 desativa o log.
  \item [-logfile] Arquivo de log gerado pelo barramento.\\
Por padrão o log é direcionado para a saída padrão (\emph{standard output}).
  \item [-oilloglevel] Nível de log gerado pelo \oil{}~\cite{maia06oil,web:oil} (debug).\\
  O valor padrão é 0, que desativa o log.
  \item [-oillogfile] Arquivo de log gerado pelo \oil{} (debug).\\
Por padrão o log é direcionado para a saída padrão (\emph{standard output}).

  \item [-noauthorizations] Desativa o suporte à autorizações de oferta.
  \item [-logaddress] Exibe o endereço IP do requisitante no log do barramento.
  \item [-nolegacy] Desativa o suporte à versão antiga do barramento.
  \item [-legacydomain] Define o domínio de autenticação de senhas para acessos com a versão antiga do barramento.\\
Caso o suporte à versão antiga do barramento esteja desabilitado essa configuração não precisa ser fornecida.
O valor padrão é a string vazia.


  \item [-nodnslookup] Desativa a busca no DNS por apelidos da máquina para compor os endereços de rede contidos nas referências IOR.\\
Por padrão, todos os apelidos de DNS são adicionados.
  \item [-noipaddress] Desativa o uso de endereços IP para compor os endereços de rede contidos nas referências IOR.\\
Por padrão, os endereços IP são adicionados.
  \item [-alternateaddr] Endereço e porta alternativos que devem compor os endereços de rede contidos nas referências IOR.\\
Essa configuração é útil para a travessia de NAT e firewalls.\\
Não é definido um valor padrão. O valor deve ser um nome e porta separados pelo caractere \code{:} (dois pontos).

  \item [-enableaudit] Ativa a publicação de dados de auditoria em serviço HTTP externo.\\
Por padrão, a auditoria está desabilitada.
  \item [-auditendpoint] Endereço e porta do serviço HTTP da auditoria.\\
O valor padrão é http://localhost:51398.
  \item [-auditproxy] Endereço e porta para o servidor de proxy HTTP.\\
O valor padrão é vazio e as conexões HTTP são realizadas diretamente.
  \item [-auditcredentials] Credenciais para autenticação pelo método básico do HTTP.\\
O valor padrão é vazio e não são enviados cabeçalhos de autenticação.
  \item [-auditparallel] Número máximo de corotinas simultâneas para o envio de dados de auditoria.\\
O valor padrão é 5. Cada corotina vai utilizar um socket comunicação HTTP.\\
É importante verificar que a soma desse número com a valor para \code{maxchannels} não ultrapasse o limite de sockets por processo.
  \item [-auditretrytimeout] Tempo em segundos para espera entre tentativas de conexão no serviço de auditoria.\\
O tempo padrão é 5 segundos.
  \item [-auditdiscardonexit] Ativa o descarte de dados de auditoria pendentes durante a parada do agente de auditoria.\\
Por padrão, o descarte está desativado. Assim serão feitas 10 retentativas de envio dos dados antes da parada completa do agente.
  \item [-auditfifolimit] Tamanho máximo da fila de envio de dados para o serviço de auditoria.\\
O tamanho padrão da fila é 100000.
  \item [-auditapplication] Identificação do código da solução no serviço de auditoria.\\
O valor padrão é OPENBUS.
  \item [-auditenvironment] Identificação da instância do barramento no serviço de auditoria.\\
O valor padrão é o \code{BusId} (criado automaticamente na primeira vez que se executa o \emph{busservices}).

  \item [-nativecharset] Identificação do \emph{codepage} dos caracteres usada quando um sistema solicita a conversão automática.\\
O valor padrão em CORBA é ISO-8859-1. Entretanto, recomenda-se usar UTF-8 que é o mais usado nos sistemas operacionais modernos.

  \item [-configs] Arquivo de configurações adicionais do barramento.\\
O valor padrão é \code{openbus.cfg}.
\end{description}

As opções \code{admin}, \code{validator}, \code{tokenvalidator} e \code{alternateaddr} podem aparecer mais de uma vez para definir multiplos valores.
(ao contrário do OpenBus 2.0, isso também é válido para definições no arquivo de configuração.)
O código~\ref{lst:openbus.cfg} apresenta um exemplo de arquivo do configuração.

\begin{htmlonly}
  \codeinput{src/openbus.cfg}{Exemplo de arquivo de configuração:} 
\end{htmlonly}

\begin{latexonly}
  \inputlisting[language=lua]{openbus.cfg}{Exemplo de arquivo de configuração.}
\end{latexonly}

Existem duas formas de se definir o arquivo de configuração que o programa irá utilizar: utilizando a opção \code{config} por linha de comando, ou definindo um valor para a variável de ambiente \emph{OPENBUS\_CONFIG}.
Quando a variável de ambiente \emph{OPENBUS\_CONFIG} não é definida, o arquivo \code{openbus.cfg} no diretório corrente é usado por default como arquivo de configuração.
Porém, as opções passadas por linha de comando têm prioridade sobre as opções definidas no arquivo de configuração.

Através da opção \code{validator} informa-se o módulo do validador de senhas que será utilizado pelo barramento. 
Disponibilizamos em \texttt{openbus.core.services.passwordvalidator.LDAP} um validador LDAP, que precisa ser configurado com a lista de servidores utilizados na autenticação. Para maiores informações sobre como configurar o validador LDAP, consulte a seção~\ref{subsubsec:ldapval}.

%% NOTE: comentado parte que falava sobre o validador de teste: 
% e em \\\texttt{openbus.test.core.services.TesterUserValidator} disponibilizamos um validador para ambientes de teste, que permite acesso quando o login é igual a senha.

Através da opção \code{tokenvalidator} pode-se informar o módulo de um validador de autenticação externa que será utilizado pelo barramento.

Também é possível desabilitar o suporte de compatibilidade com a versão anterior através da opção \code{nolegacy}. Ao ativar essa opção, o barramento deixa de permitir que entidades se autentiquem no barramento utilizando as bibliotecas de acesso de versão \legacyidlversion{}. 




\section{O executável \emph{busadmin}}

A ferramenta \emph{busadmin} facilita a gerentes do barramento a realização de atividades de governança (administração) sobre o barramento. Para informações sobre como utilizá-la, consulte~\cite{busadmin2.1manual}. Caso já esteja familiarizado com a versão \legacyidlversion{} da ferramenta, consulte também~\cite{web:busadmin2.1-2.0}.


\section{Configurações opcionais para administradores do servidor}

No pacote do barramento existem facilitadores adicionais para apoiar tarefas diárias comuns ao administrador do servidor como auditoria das chamadas recebidas no barramento, inicialização no \emph{boot} do servidor, monitoramento periódico do processo e rotacionamento de logs.

\subsection{Auditoria}

A partir da versão 2.1.0.2, o executável \emph{busservices} passou a ter uma opção (\code{-enableaudit}) para coletar dados das chamadas recebidas e enviá-los para um serviço HTTP RESTful externo. 
O envio é realizado por um cliente HTTP embutido no processo do \emph{busservices} e conhecido como agente de auditoria.
O agente de auditoria envia um POST HTTP com a informação de cada requisição coletada em formato JSON\cite{json}, conforme a seguinte estrutura:
\begin{verbatim}
{
  solutionCode : "string",
  environment : "string",
  id : "string",
  timestamp : "yyyy-mm-dd hh:mm:ss.SSS"
  actionName : "string",
  userName : "string",
  loginId : "string",
  interfaceName : "string",
  openbusProtocol : "string",
  ipOrigin : "WWW.XXX.YYY.ZZZ:PPPP",
  input : "string",
  duration : "ss.SSSS",
  output : "string",
  resultCode : "string",
}
\end{verbatim}

Os dados coletados na auditoria são detalhados a seguir. Caso não seja possível coletar algum deles, o dado será preenchido com \code{null} (ou \code{<unknown>} no caso da entidade e login).

\begin{description}
  \item [solutionCode] String com código da solução que gerou evento.\\
O valor padrão é \code{OPENBUS} e pode ser redefinido pelo parâmetro \code{auditapplication} do \emph{busservices}.
  \item [environment] String com o nome do ambiente que a solução executa.\\
O valor padrão é o mesmo do \code{BusID} (gerado automaticamente) e pode ser redefinido pelo parâmetro \code{auditenvironment} do \emph{busservices}.
  \item [id] String com identificação única do evento.\\
Valor gerado automaticamente. Exemplo: d3b0fbdb138f4bfca689d30b23e1fa38.
  \item [actionName] String com nome da ação.\\
Valor preenchido com o campo \code{request.operation_name} da requisição CORBA. Exemplo: findServices.
  \item [interfaceName]: String que contém o tipo do serviço em uso.\\
Valor do campo \code{request.interface.repID} da requisição CORBA. Exemplo: IDL:tecgraf/openbus/core/v2_1/services/offer_registry/OfferRegistry:1.0.
  \item [timestamp] String de data em que a requisição foi interceptada.\\
Valor da chamada de sistema \code{gettimeofday} no ato do recebimento da requisição. Exemplo: 2017-09-06 09:05:37.022.
  \item [userName] String com o nome da entidade que fez a solicitação.\\
Valor preenchido com o \code{CallChain.caller.entity} contido no \code{request.service_context} da requisição CORBA. Exemplo: fulano.
  \item [loginId] String que contém o UUID do login da entidade que fez a solicitação.\\
Valor preenchido com o \code{CallChain.caller.id} contido no \code{request.service_context} da requisição CORBA. Exemplo: fbedb4ba-9ce4-11e7-a153-0050569e00fc.
  \item [openbusProtocol] String com a versão do protocolo do OpenBus sendo utilizada na requisição.\\
Valor é extraído da versão dos metadados do protocolo ou do nome das interfaces (quando ainda não é uma chamada do protocolo) ou ainda do \code{request.object_key} do objeto sendo acessado. Exemplo: v2_0, v2_1.
  \item [ipOrigin] String que contém o endereço de rede (IPv4) do processo cliente que fez a requisição.\\
Valor do campo \code{request.channel_address} da requisição CORBA. Exemplo: 10.29.234.53:44000.
  \item [input] String codificada em Base64 com os parâmetros de entrada da operação.\\
Valor preenchido com campo \code{request.parameters} da requisição CORBA.
  \item [resultCode] Booleano com o resultado da operação: verdadeiro caso finalizou com sucesso e falso caso ocorreu uma exceção.\\
Valor do campo \code{request.success} da requisição CORBA.
  \item [output] String codificada em Base64 com a resposta da requisição.\\
Valor do campo \code{request.results} da requisição CORBA.
  \item [duration] Duração da chamada em milisegundos com precisão de 4 dígitos.\\
Valor observado no ato da resposta da requisição. Exemplo: 5,2314 (5 milisegundos e 231,4 microsegundos).
\end{description}

Entre os campos acima, apenas \code{environment} e \code{solutionCode} podem ser alterados através da configuração dos parâmetros \code{-auditapplication} e \code{-auditenvironment} do \emph{busservices}, respectivamente.

Recomenda-se usar o \code{-auditapplication} como um identificador da tecnologia, por exemplo \code{OPENBUS}, e o \code{-auditenvironment} como um identificador da instalação.

O serviço de auditoria, por sua vez, \textbf{não é fornecido} no pacote do barramento.
Um exemplo de código baseado em Node.JS\cite{web:nodejs} que executa uma aplicação web para efeitos de teste da auditoria é dada a seguir. 
Nesse exemplo utilize o endereço \code{http://localhost:51398} para publicar eventos sem autenticação e \code{http://localhost:51398/protected} para experimentar uso de credenciais HTTP (lembre-se de ajustar o parâmetro \code{-auditcredentials} no \emph{busservices}).
\begin{verbatim}
const express = require('express')
const app = express()

var basicAuth = require('basic-auth');

var auth = function (req, res, next) {
  function unauthorized(res) {
    res.set('WWW-Authenticate', 'Basic realm=Authorization Required');
    return res.sendStatus(401);
  };

  var user = basicAuth(req);

  if (!user || !user.name || !user.pass) {
    console.log(req.url + " access denied. missing authentication header");
    return unauthorized(res);
  };

  if (user.name === 'fulano' && user.pass === 'silva') {
    console.log(req.url + " access granted for user " + user.name);
    return next();
  } else {
    console.log(req.url + " access denied. invalid user credentials user " + user.name);
    return unauthorized(res);
  };
};

var bodyParser = require("body-parser");
app.use(bodyParser.urlencoded({extended:false}));
app.use(bodyParser.json());

const port = 51398

app.post('/protected', auth, (req, res) => {
  console.log('Received a protected event ' + req.url)
  console.log(req.body);
  res.end('');
})

app.post('/', (req, res) => {
  console.log('Received a public event ' + req.url)
  console.log(req.body);
  res.end('')
})

app.listen(port, () => console.log('Audit service app listening on port '+port))
\end{verbatim}

\subsection{Inicialização}

O pacote de instalação do barramento acompanha o script de inicialização \emph{businit} que serve para iniciar e parar o barramento, semelhante aos scripts do /etc/init.d em servidores Unix.

Recomendamos que o administrador coloque o script \emph{businit} em /etc/init.d/openbus (ou outro lugar semelhante em seu sistema operacional) e faça o link simbólico apropriado para cada \textit{runlevel}. É possível editar o script \emph{businit} para redefinir o local da instalação do barramento (variável \code{INSTALL\_DIR}), de modo que o script possa encontrar o executável do \emph{busservices}.
Alternativamente, é possível também definir a variável de ambiente \code{OPENBUS\_HOME} para indicar o local de instalação do barramento para os scripts \code{businit} e \code{buscheck} (veja a seção seguinte).

Além disso, por padrão, este script carrega configurações adicionais definidas no  arquivo \code{/etc/default/openbus}, ou ainda no arquivo \code{config/openbus.rc} do diretório de instalação do barramento.
Num desses arquivos podem ser definidas configurações adicionais tais como o nome do arquivo a ser criado para armazenar o PID do processo do \emph{busservices} disparado (variável \code{PIDFILE}), o arquivo de log do barramento (variável \code{OUTFILE}), ou ainda o mail de notificação de reinícios (variável \code{EMAIL}).

\textbf{É fortemente recomendado} que o administrador do sistema configure o barramento para utilizar um arquivo de configuração. Nesse caso, o administrador \textbf{precisa} decidir onde colocar esse arquivo de configuração. Há duas formas de fazer isso utilizando os arquivos \code{/etc/default/openbus} ou \code{config/openbus.rc}:
\begin{enumerate}
   \item Definindo a variável de ambiente \code{OPENBUS\_CONFIG}. Exemplo:
   \begin{verbatim}
   export OPENBUS_CONFIG=/etc/openbus.cfg
   \end{verbatim}
   \item Definindo a variável PARAMS com o parâmetro \code{-configs} e a localização do arquivo de configuração desejado. Exemplo:
   \begin{verbatim}
   PARAMS=-configs /etc/openbus.cfg
   \end{verbatim}
\end{enumerate} 

\subsection{Monitoramento}

O pacote de instalação do barramento acompanha o script de monitoramento \emph{buscheck} que verifica se o barramento está executando e, caso não esteja, inicia o barramento utilizando o script \emph{businit}.

O script \emph{buscheck} foi criado para ser utilizado em conjunto com o agendador de tarefas do sistema (comando \emph{cron} no Unix).
Assim como o script \code{businit}, o script \code{buscheck} também:
\begin{enumerate}
  \item Precisa ser alterado para indicar o local de instalação do barramento(variável \code{INSTALL\_DIR}).
  \item Carregará as configurações do arquivo \code{/etc/default/openbus}, ou do arquivo \code{config/openbus.rc} do diretório de instalação do barramento.
\end{enumerate}

Como o script \emph{buscheck} \textbf{depende} do script \emph{businit}, caso o administrador decida colocar o \emph{businit} em um outro local, \textbf{é importante editar o script \emph{buscheck} de acordo} (variável \code{OPENBUS\_INIT}).

Um exemplo de agendamento no \emph{cron} para utilizar o \emph{buscheck} é dado a seguir, neste exemplo consideramos que o barramento está instalado em /opt/openbus:
\begin{verbatim}
*/10 * * * * env OPENBUS_HOME=/opt/openbus /opt/openbus/bin/buscheck
\end{verbatim}

\subsection{Rotacionamento de logs}

O script \code{businit} desvia toda saída do barramento para um arquivo (veja variável \code{OUTFILE} no arquivo de configurações adicionais). É \textbf{fortemente recomendado} manter esses arquivos de saída para identificar problemas no uso do barramento.
Por isso, recomendamos uma estratégia para rotacionar esses arquivos de saída.

O comando \textbf{logrotate} é um utilitário para simplificar a administração de arquivos de logs bem comum na maioria das instalações Linux e Solaris. O logrotate permite a rotação automática, a compressão dos logs antigos, a remoção de logs muito velhos e mesmo o envio de emails contendo os arquivos de logs.

Para rotacionar os logs do barramento, basta configurar o logrotate com as linhas a seguir. Neste exemplo consideramos que o barramento salva o log em /var/log/openbus.log:
\begin{verbatim}
   /var/log/openbus.log {
    weekly
    compress
    copytruncate
    rotate 4
   }
\end{verbatim}

Os significados das opções recomendadas acima são dados a seguir:
\begin{enumerate}
   \item O rotacionamento dos logs ocorre \textbf{semanalmente}.
   \item Os logs antigos são comprimidos.
   \item A opção \textbf{copytruncate} é necessária, pois o barramento escreve continuamente no log e ocorrerá erro de escrita em disco, caso os descritores de arquivos sejam alterados. Essa opção copia os arquivos de logs e, depois, reseta o arquivo original. É o procedimento mais seguro nesses casos.
   \item Armazena-se até \textbf{4} volumes dos logs antigos.
\end{enumerate}

\subsubsection{Rotacionamento de logs usando o logadm (plataforma Solaris)}

O \textbf{logadm} é muito parecido com o logrotate. Para a rotação dos logs, nós iremos utilizar o crontab e o logadm.
Caso não seja o root da máquina, você deve utilizar o parâmetro -f para informar um arquivo de configuração. Esse arquivo irá conter todos os logs que você deseja rotacionar. Abaixo temos um exemplo de como configurar o logadmin para rotacionar os logs do barramento.

\begin{itemize}
   \item O agendamento do cron que faz o logadm ser executado todo dia às 5:00AM:
   \begin{verbatim}
   00 05 * * * /usr/sbin/logadm -f /etc/openbus-logadm.conf
   \end{verbatim}
   \item No arquivo /etc/openbus-logadm.conf temos:
   \begin{verbatim}
   /var/log/openbus.log -C 5 -P 'Mon Jul 26 20:13:01 2010' -c -p 7d -z 0
   \end{verbatim}
\end{itemize}

Os significados das opções recomendadas acima são dados a seguir:
\begin{enumerate}
   \item Os parâmetros \texttt{-C 5 -c -p 7d -z 0} fazem com que o logadm guarde os 5 últimos logs, truncando-os e comprimindo-os no formato .gz. Essa ação será feita a cada 7 dias.
   \item O parâmetro \texttt{-P} será adicionado pelo próprio logadm após a primeira execução, ele é responsável por controlar a próxima data que o rotacionamento ocorrerá.
\end{enumerate}

\section{FAQ}\label{sec:faq}

\subsection{Não lembro a sintaxe do crontab. Qual é ela mesmo?}

\begin{verbatim}   
.---------------- minuto (0 - 59)
|  .------------- hora (0 - 23)
|  |  .---------- dia do mês (1 - 31)
|  |  |  .------- mês (1 - 12) 
|  |  |  |  .---- dia da semana (0 - 6) (Domingo=0 ou 7) 
|  |  |  |  |
*  *  *  *  *  comando a ser executado e suas opções
\end{verbatim}

\subsection{Não lembro como editar o agendamento do cron. Como é mesmo?}

Para adicionar um novo agendamento pode-se usar o arquivo global /etc/crontab (caso seja root) ou editar a tabela específica do usuário (todo usuário pode usar o cronpara rodar tarefas periódicas). O comando é:
\begin{verbatim}
crontab -e
\end{verbatim}

Um arquivo com os agendamentos já existentes será aberto e será possível adicionar conforme informado anteriormente. Se o arquivo está vazio é porque o usuário do sistema não tem nenhum agendamento ainda.

\subsection{Onde devo salvar o arquivo de configuração do logrotate?}

A maioria das instalações Linux recentes já dispõem do diretório /etc/logrotate.d. Nesses casos, basta criar um arquivo chamado openbus (pode ser outro nome de sua preferência) e salvar as configurações acima nele.

É importante que o administrador leia as páginas de manual do logrotate (man logrotate), pois podem haver diferenças na configuração para versões antigas desse utilitário. Uma das situações comuns é não haver suporte ao diretório /etc/logrotate.d. Nesses casos, basta adicionar as configurações acima no arquivo /etc/logrotate.conf.

\subsection{Precisa ser configurada alguma permissão especial? Qual o owner e o grupo que a configuração do logrotate precisa ter?}

Não é necessário nenhuma permissão especial, basta o proprietário ser root e ter leitura para qualquer usuário (pode haver plataformas onde o logrotate execute como outro usuário que não o root).

\subsection{Onde os arquivos rotacionados são armazenados?}

No mesmo diretório dos arquivos originais.

\subsection{Preciso executar o comando \code{logrotate /etc/logrotate.d/openbus}?}

Não é preciso. Normalmente o logrotate é cadastrado como uma tarefa diária no cron. Mas isso não impede de que o administrador execute tal comando passando o parâmetro \-\-force para obrigar o primeiro rotacionamento. Isso é indicado principalmente logo após a configuração inicial.

\subsection{Preciso configurar para o comando \code{logrotate /etc/logrotate.d/openbus} ser colocado na inicialização automática da máquina? Como saber que ele está executando?}

O logrotate não é um daemon, portanto não se mantém em execução. Normalmente, o logrotate é executado através do agendamento do cron. Caso não haja cron disponível em uma dada plataforma, então nesse caso será sim importante executar o comando do logrotate na inicialização da máquina.

\subsection{Como usar o logrotate SEM precisar ter acesso de administrador na máquina?}

O logrotate pode ser usado por usuários desprivilegiados (aqueles que não possuem acesso de root). Contudo, é muito comum que esses usuários ainda queiram rotacionar periodicamente seus arquivos de log. Nessa situação, recomendamos que o usuário adicione regras no agendador de tarefas do Unix (cron) para que o comando do logrotate seja chamado (ao menos) diariamente.

Para usuários desprivilegiados é importante usar alguns parâmetros do logrotate como o \-\-state. Esse parâmetro indica qual arquivo de estados será usado. O logrotate usa tal arquivo de estado para registrar a data da última rotação.

Segue um exemplo de agendamento do cron para executar o logrotate diariamente às 12:00 horas para o barramento instalado em /opt/openbus:

\begin{verbatim}
  0 12 * * * /usr/sbin/logrotate --state /opt/openbus/logrotate.status /etc/openbus-logrotate.conf   
\end{verbatim}

É importante notar que o arquivo logrotate.status contendo o último estado da rotação foi mantido no diretório da instalação do barramento.

\subsection{Como instalar o logrotate como usuário comum numa Solaris 10?}

Nas plataformas Solaris a forma mais simples é baixar o pacote binário a partir do SunFreeware e usar diretamente da pasta do usuário. Um exemplo é dado a seguir:
\begin{enumerate}
   \item Download e extração do pacote a partir do sunfreeware:
   \begin{verbatim}
   wget -c ftp://ftp.sunfreeware.com/pub/freeware/sparc/10/logrotate-3.7.6-sol10-sparc-local.gz
   gunzip logrotate-3.7.6-sol10-sparc-local.gz
   mkdir /tmp/install
   pkgtrans logrotate-3.7.6-sol10-sparc-local /tmp/install      
   \end{verbatim}
   \item Entendendo o conteúdo do pacote e copiando para uma pasta pessoal o binário principal:
   \begin{verbatim}
   ls -l /tmp/install/SMClogr/reloc/
     drwxr-xr-x   3 openbus  tecgraf      512 Apr 12 15:24 doc
     drwxr-xr-x   3 openbus  tecgraf      512 Apr 12 15:24 man
     drwxr-xr-x   2 openbus  tecgraf      512 Apr 12 15:24 sbin
   cp /tmp/install/SMClogr/reloc/sbin/logrotate $HOME/bin
   \end{verbatim}
\end{enumerate}

Após esse procedimento basta ter a pasta \$HOME/bin no PATH.

\subsection{Como configuro um validador de senha?}

Um exemplo simples de configuração de um validador de senha seria criar um código como o apresentado em \ref{subsec:valsenha}, e salvar o código em um arquivo com a extensão \code{.lua}. Depois, adicione o caminho onde foi salvo o arquivo à variável de ambiente LUA\_PATH, da seguinte forma: 

\begin{verbatim}
export LUA_PATH+=";<caminho onde está o validador>/?.lua"
\end{verbatim}

Para maiores informações, consulte o manual da linguagem Lua~\cite{web:luamodule}.

\subsection{Ainda estou com dúvidas. Como entro em contato?}

Disponibilizamos uma lista pública de discussão com o intuito de reconhecer os usuários da nossa tecnologia, bem como receber sugestões e críticas que contribuam para a evolução do nosso projeto.

Maiores informações sobre a nossa lista de discussão veja \url{http://listas.tecgraf.puc-rio.br/mailman/listinfo/openbus-users}.

\bibliographystyle{plain}
\bibliography{../references}

\end{document}
