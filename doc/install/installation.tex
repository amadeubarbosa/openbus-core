%
%  Documento de Instalação do OpenBus 2.0
%
%  Created by Hugo Roenick on 2012-05-22.
%  Copyright (c) 2012 Tecgraf/PUC-Rio. All rights reserved.
%
\documentclass[]{article}

% Use utf-8 encoding for foreign characters
\usepackage[latin1]{inputenc}

\usepackage[brazil]{babel}

% Setup for fullpage use
\usepackage{fullpage}

% Uncomment some of the following if you use the features
%
% Running Headers and footers
%\usepackage{fancyhdr}

% Multipart figures
%\usepackage{subfigure}

% More symbols
%\usepackage{amsmath}
%\usepackage{amssymb}
%\usepackage{latexsym}

\usepackage{hyperref}

% Surround parts of graphics with box
\usepackage{boxedminipage}

% Package for including code in the document
\usepackage{../mwlabinputs2}

% If you want to generate a toc for each chapter (use with book)
\usepackage{minitoc}

% This is now the recommended way for checking for PDFLaTeX:
\usepackage{ifpdf}

%% Redefines the label 'Listing' for ..
\def\lstlistingname{Código}
\codestyle{colorful}

% new commands
\newcommand{\term}[1]{\textit{#1}}
\newcommand{\code}[1]{\texttt{#1}}

\newcommand{\openbus}{\textsc{OpenBus}}
\newcommand{\corba}{\textsc{CORBA}}
\newcommand{\orb}{\textsc{ORB}}
\newcommand{\scs}{\textsc{SCS}}
\newcommand{\lua}{\textsc{Lua}}
\newcommand{\oil}{\textsc{OiL}}
\newcommand{\version}{2.0.0}


%\newif\ifpdf
%\ifx\pdfoutput\undefined
%\pdffalse % we are not running PDFLaTeX
%\else
%\pdfoutput=1 % we are running PDFLaTeX
%\pdftrue
%\fi

\ifpdf
\usepackage[pdftex]{graphicx}
\else
\usepackage{graphicx}
\fi

\title{Manual de instalação do \openbus{} \version{}}
\author{Tecgraf}

\date{\today}

\begin{document}

\ifpdf
\DeclareGraphicsExtensions{.pdf, .jpg, .tif}
\else
\DeclareGraphicsExtensions{.eps, .jpg}
\fi

\maketitle

\tableofcontents

\section{Introdução}

Este documento visa informar apenas o procedimento necessário para instalar um barramento \openbus{}~\cite{web:OPENBUS} da versão \version{}.
Caso tenha interesse de entender melhor o que é um barramento \openbus{}, consulte o seu manual de referência~\cite{ob2.0core}.

\section{Instalação}

O primeiro passo para instalar o barramento deve ser descompactar o pacote do barramento da plataforma desejada.
Os pacotes estão disponibilizados no site oficial do projeto: \url{http://www.tecgraf.puc-rio.br/openbus}.

As plataformas oficialmente suportadas são:
\begin{itemize}
  \item Linux Kernel 2.6 glibc 2.5 64 bits (Linux26g4\_64)
  \item Linux Kernel 2.6 glibc 2.5 32 bits (Linux26g4)
\end{itemize}

Para outras plataformas geramos pacotes sob demanda, exemplos:
\begin{itemize}
  \item Linux Kernel 3.2 glibc 2.11 64 bits (Linux32\_64)
  \item Linux Kernel 3.2 glibc 2.11 32 bits (Linux32)
  \item Linux Kernel 2.4 glibc 2.3 64 bits (Linux24g3\_64)
  \item Linux Kernel 2.4 glibc 2.3 32 bits (Linux24g3)
  \item Solaris 10 release 8/07 SPARC 64 bits (SunOS510\_64)
  \item Solaris 10 release 8/07 SPARC 32 bits (SunOS510)
\end{itemize}

Os exemplos deste documento utilizam comandos do Bash shell (interpretador de linguagem de comandos)~\cite{web:bash}. 
Para executar o barramento deve-se seguir o seguinte procedimento:

\begin{enumerate}
  \item Extrair o pacote.
  Para fins de legibilidade, vamos guardar o caminho do local da extração em uma variável de ambiente. 
  Porém, \textbf{essa declaração não é obrigatória!}
\begin{verbatim}  
export OPENBUS_HOME=<local de extracao do pacote>
\end{verbatim}
  
  \item Testar se a execução do binário do barramento está funcionando
\begin{verbatim}  
$OPENBUS_HOME/bin/busservices --help
\end{verbatim}

  \item Gerar um par de chaves com tamanho de 2048 bits para o barramento.
  A chave privada (arquivo com terminação \emph{.key}) deve ser do formato PKCS8 codificada em DER, e o certificado (arquivo com terminação \emph{.crt}) deve ser do formato X.509 codificado em DER.
  Esse par de chaves deve ser criado utilizando o comando \emph{openssl} que acompanha o pacote.
\begin{verbatim}
  export LD_LIBRARY_PATH="${OPENBUS_HOME}/lib:${LD_LIBRARY_PATH}"
  
  # caso seja MacOS é preciso também:
  export DYLD_LIBRARY_PATH="${OPENBUS_HOME}/lib:${DYLD_LIBRARY_PATH}"

  ${OPENBUS_HOME}/bin/openssl genrsa -out tmp_openssl.key 2048
  ${OPENBUS_HOME}/bin/openssl pkcs8 -topk8 -nocrypt \
    -in tmp_openssl.key -out <nome do par de chaves>.key -outform DER
  rm -f tmp_openssl.key
  ${OPENBUS_HOME}/bin/openssl req -config ${OPENBUS_HOME}/openssl/openssl.cnf -new -x509 \
    -key <nome do par de chaves>.key -keyform DER \
    -out <nome do par de chaves>.crt -outform DER
\end{verbatim}

  \item Configurar o validador (ver próxima seção) e executar o barramento (binário \emph{busservices}), passando as configurações da chave privada e do validador a serem utilizados, as quais são obrigatórias para execução do OpenBus.

\end{enumerate}

Maiores informações sobre como utilizar a configuração do \emph{busservices} podem ser encontradas no manual de referência~\cite{ob2.0core}.

\section{Validadores}

\subsection{Para que servem?}

Os validadores representam o conceito de um módulo Lua~\cite{web:luamodule} responsável por verificar se o par usuário e senha fornecido em uma tentativa de autenticação junto ao barramento é válido. 
Atualmente pode-se utilizar 2 tipos de validadores no OpenBus: validadores LDAP ou validadores personalizados.

\begin{itemize}
\item Validadores LDAP - usam as informações contidas em um serviço de diretórios LDAP para autenticar o acesso de usuários ao barramento. Em ambientes corporativos, é comum a administração da rede utilizar servidores LDAP~\cite{web:rfc4510,wiki:LDAP} para a autenticação de usuários.
\item Validadores personalizados - utilizam funções escritas em Lua para verificar a autenticidade dos usuários.
\end{itemize}


\subsection{Validadores LDAP}

O validador LDAP, disponibilizado em \texttt{openbus.core.services.passwordvalidator.LDAP}, tem suporte a servidores Microsoft Active Directory e OpenLDAP. As configurações do validador precisam estar no arquivo de configuração que é informado ao \emph{busservices} através do parâmetro ``-configs''. A seguir apresentamos quais são as propriedades, seus significados e possíveis valores:
\begin{description}
\item[ldap\_servers] indica uma lista de URLs de servidores LDAP. Cada URL deve seguir o formato \\ \texttt{<protocol>://<server>:<port>}, onde \texttt{<protocol>} pode ser \texttt{ldaps} ou \texttt{ldap}. Exemplo:
\begin{verbatim}
ldap_servers = { 
 "ldaps://server.mycompany.com",
 "ldap://otherserver.mycompany.com:389",
}
\end{verbatim}

\item[ldap\_patterns] indica uma lista de padrões de formação de nomes que serão usados na autenticação LDAP. Atualmente só há suporte para o padrão \texttt{\%U}, e o validador irá substituir esse padrão pelo nome do usuário fornecido no ato do login. No exemplo abaixo apresentamos dois padrões, o primeiro é útil para autenticação em servidores Microsoft Active Directory (que utilizam UPN~\cite{web:upn}) e o segundo é útil para autenticação em servidores OpenLDAP (que utilizam DN~\cite{web:dn,web:rfc4514}). Exemplo:
\begin{verbatim}
ldap_patterns = {
  "%U@project.mycompany.com",
  "cn=%U,ou=users,ou=groups,dc=company",
}
\end{verbatim}

\item[ldap\_timeout] indica um tempo máximo de espera (em segundos) da resposta do servidor LDAP. Exemplo:
\begin{verbatim}
ldap_timeout = 10
\end{verbatim}
\end{description}


\subsection{Validadores personalizados}\label{subsec:valpersonalizados}

Um validador personalizado precisa ser um módulo Lua~\cite{web:luamodule} que deve retornar uma função que recebe como parâmetro uma tabela de configurações do barramento e retorna uma função \texttt{validator}.
A função \texttt{validator} recebe como primeiro parâmetro o nome de usuário e, como segundo, a senha.
Caso o par usuário/senha seja válido, deve-se retornar verdadeiro, caso contrário, falso.
Um exemplo de validador que verifica se o nome do usuário é igual à senha é dado a seguir:
\begin{verbatim}
-- this is the validator function
local function validator(name, password)
  if name == password then
    return true
  end
end

-- returning the factory to validation function
return function(configs) return validator end
\end{verbatim}

Então, sempre que este módulo for carregado, ele retornará a fábrica de função de validação.
\begin{verbatim}
-- dummy usage example of this validation module
local factory = require "example.of.validator"
local validator = factory() 
local isValid = validator(login, password)
\end{verbatim}

Podemos implementar os validadores tão simples ou seguros como desejarmos.
Importante frisar que o validador personalizado precisa estar no LUA\_PATH para que seja encontrado pelo executável \emph{busservices}.
Um exemplo de como configurar o LUA\_PATH para um validador personalizado é apresentado no FAQ (seção~\ref{sec:faq}).




\section{Configurações opcionais para administradores do servidor}

No pacote de instalação do barramento existem scripts que auxiliam algumas tarefas diárias comuns ao administrador da máquina onde o barramento está instalado. Esses scripts estão localizados na pasta \emph{bin} e são eles:
\begin{description}
   \item[bus-init] script de inicialização para iniciar e parar o barramento, semelhante aos scripts do /etc/init.d em servidores Unix.
   \item[bus-check-running] script que verifica se o barramento está executando e, caso não esteja, inicia o barramento utilizando o script \emph{bus-init}.
\end{description}

\subsection{Inicialização}

Recomendamos que o administrador coloque o script \emph{bus-init} em /etc/init.d/openbus (ou outro lugar semelhante em seu sistema operacional) e faça o link simbólico apropriado para cada \textit{runlevel}. É \textbf{necessário editar o script \emph{bus-init}} para redefinir o local da instalação do barramento, de modo que o script possa encontrar o executável do \emph{busservices}. 

Além disso, por padrão, este script salva um arquivo de nome \emph{busservices.pid} (contendo o PID do processo do \emph{busservices}) dentro do diretório de instalação do barramento. Caso o administrador queira, ele também pode mudar a localização desse arquivo dentro do script.

Para utilizar o script \emph{bus-init} \textbf{é recomendado} que o administrador do sistema configure o barramento para utilizar um arquivo de configuração. Nesse caso, o administrador \textbf{precisa} decidir onde colocar esse arquivo de configuração. Há duas formas de fazer isso utilizando o \emph{bus-init}:
\begin{enumerate}
   \item Criando um arquivo /etc/default/openbus e definindo a variável OPENBUS\_CONFIG. Exemplo:
   \begin{verbatim}
   OPENBUS_CONFIG=/etc/openbus.cfg
   export OPENBUS_CONFIG
   \end{verbatim}
   \item Editando o script \emph{bus-init} e alterando a variável PARAMS com o parâmetro ``-configs'' e a localização do arquivo de configuração desejado. Exemplo:
   \begin{verbatim}
   PARAMS=-configs /etc/openbus.cfg
   \end{verbatim}
\end{enumerate} 

\subsection{Monitoramento}

O script \emph{bus-check-running} foi criado para ser utilizado em conjunto com o agendador de tarefas do sistema (comando \emph{cron} no Unix). Este script \textbf{aceita dois parâmetros} sendo que apenas o primeiro é obrigatório. O primeiro argumento deve indicar o local de instalação do barramento e o segundo um destinatário de email para receber as notificações de reinício do barramento (caso não seja informado, será enviado email para root@<hostname>). É importante observar que este script \textbf{depende} do script \emph{bus-init}.

Além disso, caso o administrador coloque o \emph{bus-init} em outro local (que não seja /etc/init.d/openbus), \textbf{será necessário editar o script \emph{bus-check-running}} para redefinir a variável OPENBUS\_INIT. Da mesma forma, caso o administrador altere o local do arquivo \emph{busservices.pid} \textbf{também será necessário editar este script} para redefinir a variável PID\_BUSSERVICES.

Um exemplo de agendamento no \emph{cron} para utilizar o \emph{bus-check-running} é dado a seguir, neste exemplo consideramos que o barramento está instalado em /opt/openbus-2.0:
\begin{verbatim}
*/10 * * * * /opt/openbus-2.0/bin/bus-check-running /opt/openbus-2.0
\end{verbatim}

\subsection{Rotacionamento de logs}

Por padrão, o barramento imprime logs em tela. É \textbf{fortemente recomendado} configurar o barramento para salvar esses logs em arquivos, conforme documentado em~\cite{ob2.0core}. Por isso, recomendamos uma estratégia para rotacionar os arquivos de log.

O comando \textbf{logrotate} é um utilitário para simplificar a administração de arquivos de logs bem comum na maioria das instalações Linux e Solaris. O logrotate permite a rotação automática, a compressão dos logs antigos, a remoção de logs muito velhos e mesmo o envio de emails contendo os arquivos de logs.

Para rotacionar os logs do barramento, basta configurar o logrotate com as linhas a seguir. Neste exemplo consideramos que o barramento salva o log em /var/log/openbus.log:
\begin{verbatim}
   /var/log/openbus.log {
    weekly
    compress
    copytruncate
    rotate 4
   }
\end{verbatim}

Os significados das opções recomendadas acima são dados a seguir:
\begin{enumerate}
   \item O rotacionamento dos logs ocorre \textbf{semanalmente}.
   \item Os logs antigos são comprimidos.
   \item A opção \textbf{copytruncate} é necessária, pois o barramento escreve continuamente no log e ocorrerá erro de escrita em disco, caso os descritores de arquivos sejam alterados. Essa opção copia os arquivos de logs e, depois, reseta o arquivo original. É o procedimento mais seguro nesses casos.
   \item Armazena-se até \textbf{4} volumes dos logs antigos.
\end{enumerate}

\subsubsection{Rotacionamento de logs usando o logadm (plataforma Solaris)}

O \textbf{logadm} é muito parecido com o logrotate. Para a rotação dos logs, nós iremos utilizar o crontab e o logadm.
Caso não seja o root da máquina, você deve utilizar o parâmetro -f para informar um arquivo de configuração. Esse arquivo irá conter todos os logs que você deseja rotacionar. Abaixo temos um exemplo de como configurar o logadmin para rotacionar os logs do barramento.

\begin{itemize}
   \item O agendamento do cron que faz o logadm ser executado todo dia às 5:00AM:
   \begin{verbatim}
   00 05 * * * /usr/sbin/logadm -f /etc/openbus-logadm.conf
   \end{verbatim}
   \item No arquivo /etc/openbus-logadm.conf temos:
   \begin{verbatim}
   /var/log/openbus.log -C 5 -P 'Mon Jul 26 20:13:01 2010' -c -p 7d -z 0
   \end{verbatim}
\end{itemize}

Os significados das opções recomendadas acima são dados a seguir:
\begin{enumerate}
   \item Os parâmetros \texttt{-C 5 -c -p 7d -z 0} fazem com que o logadm guarde os 5 últimos logs, truncando-os e comprimindo-os no formato .gz. Essa ação será feita a cada 7 dias.
   \item O parâmetro \texttt{-P} será adicionado pelo próprio logadm após a primeira execução, ele é responsável por controlar a próxima data que o rotacionamento ocorrerá.
\end{enumerate}

\section{FAQ}\label{sec:faq}

\subsection{Não lembro a sintaxe do crontab. Qual é ela mesmo?}

\begin{verbatim}   
.---------------- minuto (0 - 59)
|  .------------- hora (0 - 23)
|  |  .---------- dia do mês (1 - 31)
|  |  |  .------- mês (1 - 12) 
|  |  |  |  .---- dia da semana (0 - 6) (Domingo=0 ou 7) 
|  |  |  |  |
*  *  *  *  *  comando a ser executado e suas opções
\end{verbatim}

\subsection{Não lembro como editar o agendamento do cron. Como é mesmo?}

Para adicionar um novo agendamento pode-se usar o arquivo global /etc/crontab (caso seja root) ou editar a tabela específica do usuário (todo usuário pode usar o cronpara rodar tarefas periódicas). O comando é:
\begin{verbatim}
crontab -e
\end{verbatim}

Um arquivo com os agendamentos já existentes será aberto e será possível adicionar conforme informado anteriormente. Se o arquivo está vazio é porque o usuário do sistema não tem nenhum agendamento ainda.

\subsection{Onde devo salvar o arquivo de configuração do logrotate?}

A maioria das instalações Linux recentes já dispõem do diretório /etc/logrotate.d. Nesses casos, basta criar um arquivo chamado openbus (pode ser outro nome de sua preferência) e salvar as configurações acima nele.

É importante que o administrador leia as páginas de manual do logrotate (man logrotate), pois podem haver diferenças na configuração para versões antigas desse utilitário. Uma das situações comuns é não haver suporte ao diretório /etc/logrotate.d. Nesses casos, basta adicionar as configurações acima no arquivo /etc/logrotate.conf.

\subsection{Precisa ser configurada alguma permissão especial? Qual o owner e o grupo que a configuração do logrotate precisa ter?}

Não é necessário nenhuma permissão especial, basta o proprietário ser root e ter leitura para qualquer usuário (pode haver plataformas onde o logrotate execute como outro usuário que não o root).

\subsection{Onde os arquivos rotacionados são armazenados?}

No mesmo diretório dos arquivos originais.

\subsection{Preciso executar o comando ``logrotate /etc/logrotate.d/openbus''?}

Não é preciso. Normalmente o logrotate é cadastrado como uma tarefa diária no cron. Mas isso não impede de que o administrador execute tal comando passando o parâmetro \-\-force para obrigar o primeiro rotacionamento. Isso é indicado principalmente logo após a configuração inicial.

\subsection{Preciso configurar para o comando ``logrotate /etc/logrotate.d/openbus'' ser colocado na inicialização automática da máquina? Como saber que ele está executando?}

O logrotate não é um daemon, portanto não se mantém em execução. Normalmente, o logrotate é executado através do agendamento do cron. Caso não haja cron disponível em uma dada plataforma, então nesse caso será sim importante executar o comando do logrotate na inicialização da máquina.

\subsection{Como usar o logrotate SEM precisar ter acesso de administrador na máquina?}

O logrotate pode ser usado por usuários desprivilegiados (aqueles que não possuem acesso de root). Contudo, é muito comum que esses usuários ainda queiram rotacionar periodicamente seus arquivos de log. Nessa situação, recomendamos que o usuário adicione regras no agendador de tarefas do Unix (cron) para que o comando do logrotate seja chamado (ao menos) diariamente.

Para usuários desprivilegiados é importante usar alguns parâmetros do logrotate como o \-\-state. Esse parâmetro indica qual arquivo de estados será usado. O logrotate usa tal arquivo de estado para registrar a data da última rotação.

Segue um exemplo de agendamento do cron para executar o logrotate diariamente às 12:00 horas para o barramento instalado em /opt/openbus-2.0:

\begin{verbatim}
  0 12 * * * /usr/sbin/logrotate --state /opt/openbus-2.0/logrotate.status /etc/openbus-logrotate.conf   
\end{verbatim}

É importante notar que o arquivo logrotate.status contendo o último estado da rotação foi mantido no diretório da instalação do barramento.

\subsection{Como instalar o logrotate como usuário comum numa Solaris 10?}

Nas plataformas Solaris a forma mais simples é baixar o pacote binário a partir do SunFreeware e usar diretamente da pasta do usuário. Um exemplo é dado a seguir:
\begin{enumerate}
   \item Download e extração do pacote a partir do sunfreeware:
   \begin{verbatim}
   wget -c ftp://ftp.sunfreeware.com/pub/freeware/sparc/10/logrotate-3.7.6-sol10-sparc-local.gz
   gunzip logrotate-3.7.6-sol10-sparc-local.gz
   mkdir /tmp/install
   pkgtrans logrotate-3.7.6-sol10-sparc-local /tmp/install      
   \end{verbatim}
   \item Entendendo o conteúdo do pacote e copiando para uma pasta pessoal o binário principal:
   \begin{verbatim}
   ls -l /tmp/install/SMClogr/reloc/
     drwxr-xr-x   3 openbus  tecgraf      512 Apr 12 15:24 doc
     drwxr-xr-x   3 openbus  tecgraf      512 Apr 12 15:24 man
     drwxr-xr-x   2 openbus  tecgraf      512 Apr 12 15:24 sbin
   cp /tmp/install/SMClogr/reloc/sbin/logrotate $HOME/bin
   \end{verbatim}
\end{enumerate}

Após esse procedimento basta ter a pasta \$HOME/bin no PATH.

\subsection{Como configuro um validador personalizado?}

Um exemplo simples de configuração de um validador personalizado, seria criar um código como o apresentado em \ref{subsec:valpersonalizados}, e salvar o código em um arquivo com a extensão ``.lua''. Depois, adicione o caminho onde foi salvo o arquivo à variável de ambiente LUA\_PATH, da seguinte forma: 

\begin{verbatim}
export LUA_PATH+=";<caminho onde está o validador>/?.lua"
\end{verbatim}

Para maiores informações, consulte o manual da linguagem Lua~\cite{web:luamodule}.

\subsection{Ainda estou com dúvidas. Como entro em contato?}

Disponibilizamos uma lista pública de discussão com o intuito de reconhecer os usuários da nossa tecnologia, bem como receber sugestões e críticas que contribuam para a evolução do nosso projeto.

Maiores informações sobre a nossa lista de discussão veja \url{http://listas.tecgraf.puc-rio.br/mailman/listinfo/openbus-users}.

\bibliographystyle{plain}
\bibliography{../references}

\end{document}
